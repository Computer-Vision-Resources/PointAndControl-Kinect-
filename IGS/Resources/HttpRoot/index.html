<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Point&amp;Control</title>
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="css/themes/default/jquery.mobile-1.4.5.min.css" />
    <link rel="stylesheet" href="css/site.css" />
    <script src="js/jquery.min.js"></script>
    <script src="js/jquery.mobile-1.4.5.min.js"></script>
  </head>
  <body>
    <script> 
//<![CDATA[
      // check if vibration is supported
      var supportsVibrate = "vibrate" in navigator;

      var toast = function(msg){
        $("<div class='ui-loader ui-overlay-shadow ui-body-e ui-corner-all toast'>"+msg+"</div>")
        .css({ padding: "5px",
          width: "290px",
          left: ($(window).width() - 300)/2,
          top: "0.7em" })
        .appendTo( $.mobile.pageContainer ).delay( 1500 )
        .fadeOut( 400, function(){
          $(this).remove();
        });
        
        if (supportsVibrate) {
          navigator.vibrate([100, 100, 100, 100, 100]);
        }
      }
       

      // TODO: abstract commands into single function
      var updateDeviceList = function( event ) {
        $.getJSON('/?dev=server&cmd=list', function (data) {
          var items = [];

          if (!data || !data.devices || data.devices.length == 0) {
            $( '#devicelist' ).html('<li>No devices in list</li>');
            $( '#devicelist' ).listview('refresh');
            
            return;
          }
          
          for (var i = 0; i < data.devices.length; i++) {
            var device = data.devices[i];
            items.push('<li><a href="/?dev=' + device.id + '&cmd=getControlPath" data-ajax="false">' + device.name + '</a></li>');
          }

          $( '#devicelist' ).html(items.join(''));
          $( '#devicelist' ).listview('refresh');
        });
      }
      
      var registerUser = function() {
        $.getJSON('/?dev=server&cmd=addUser', function (data) {
          var items = [];

          if (!data) {            
            return;
          }
          
          if (data.success){
            // start polling server
            setTimeout(pollStatus, 1000);
          }
          
          //TODO: check response          
        });
      }
      
      var activateGestureControl = function () {
        $.getJSON('/?dev=server&cmd=activateGestureCtrl', function (data) {
          var items = [];

          if (!data) {            
            return;
          }
          
          if (data.msg != '') {
            toast(data.msg);
          }
          
          if (data.success) {
            if (supportsVibrate) {
              navigator.vibrate(500);
            }
            $( ':mobile-pagecontainer' ).pagecontainer( 'change', '#point');
          }        
        });
      }
      
      var selectDevice = function () {
        $.getJSON('/?dev=server&cmd=selectDevice', function (data) {
          var items = [];

          if (!data || !data.devices) {            
            return;
          }
          
          if (data.msg != '') {
            toast(data.msg);
          }
          
          if (data.success) {
            if (supportsVibrate) {
              navigator.vibrate(500);
            }
            window.location.assign('/?dev=' + data.devices[0].id + '&cmd=getControlPath');
          }        
        });
      }
      
      var pollStatus = function () {
        // get status from server and generate toast
        $.getJSON('/?dev=server&cmd=popup', function (data) {
          var items = [];

          if (!data) {            
            return;
          }
          
          if (data.msg != '') {
            toast(data.msg);
          }
          
          //TODO: react properly on content/status
          if (data.success) {
            setTimeout(pollStatus, 1000);
          } else {
            setTimeout(registerUser(), 1000);
          }
        });
      }

      $( function(event) {
        // add user on server
        registerUser();
        
        // activate gesture control
        $( '#activate' ).on('click', function(event) {
          activateGestureControl();
        });
        
        // get device pointed at
        $( '#pointdevice' ).on('click', function(event) {
          selectDevice();
        });
      
        $(document).on('pagecontainerbeforetransition', function(event, ui){
          hash = ui.absUrl ? $.mobile.path.parseUrl(ui.absUrl).hash : "";
          if (hash == '#listdevices') {
            updateDeviceList(event);
          }
        });
      }); 
//]]>
    </script>

    <div data-role="page" id="register">
      <div data-role="header" data-position="fixed" data-tap-toggle="false">
        <h1>Please Register</h1>
      </div>
      <!-- /header -->

      <div role="main" class="ui-content fullscreen">
        <div id="activate">Raise your arm and touch the screen</div>
      </div>
      <!-- /content -->

      <div data-role="footer" data-position="fixed" data-tap-toggle="false">
        <div data-role="navbar" data-iconpos="right">
          <ul>
            <li>
              <a href="#listdevices" class="btn-skip ui-title" data-icon="carat-r">Skip to list</a>
            </li>
          </ul>
        </div>
      </div>
      <!-- /footer -->
    </div>

    <div data-role="page" id="point">
      <div data-role="header" data-position="fixed" data-tap-toggle="false">
        <h1>Select Device</h1>
        <a href="#register" data-rel="back" class="ui-btn-left ui-btn ui-btn-inline ui-corner-all ui-btn-icon-left ui-icon-carat-l">Back</a>
      </div>
      <!-- /header -->

      <div role="main" class="ui-content fullscreen">
        <div id="pointdevice">Point and touch the screen</div>
      </div>
      <!-- /content -->

      <div data-role="footer" data-position="fixed" data-tap-toggle="false">
        <div data-role="navbar" data-iconpos="right">
          <ul>
            <li>
              <a href="#listdevices" class="btn-skip" data-icon="carat-r">Skip to list</a>
            </li>
          </ul>
        </div>
      </div>
      <!-- /footer -->
    </div>

    <div data-role="page" id="listdevices">
      <div data-role="header" data-position="fixed" data-tap-toggle="false">
        <h1>Select Device</h1>
        <a href="#register" data-rel="back" class="ui-btn-left ui-btn ui-btn-inline ui-corner-all ui-btn-icon-left ui-icon-carat-l">Back</a>
        <a href="#adddevice" class="ui-btn-right ui-btn ui-btn-inline ui-corner-all ui-btn-icon-right ui-icon-plus">New</a>
      </div>
      <!-- /header -->

      <div role="main" class="ui-content">
        <ul id="devicelist" data-role="listview">
          <li>No devices in list</li>
        </ul>
      </div>
      <!-- /content -->

    </div>

    <div data-role="page" data-dialog="true" id="adddevice">
      <div data-role="header">
        <h1>Add New Device</h1>
      </div>
      <!-- /header -->

      <div role="main" class="ui-content">
        <form>
          <div class="ui-field-contain">
            <label for="text-name">Device name:</label>
            <input type="text" name="text-name" id="text-name" value="" />
        </div>
          <div class="ui-field-contain">
            <label for="text-type">Type:</label>
            <input type="text" name="text-type" id="text-type" value="" />
        </div>
          <div class="ui-field-contain">
            <label for="text-id">ID:</label>
            <input type="text" name="text-id" id="text-id" value="" />
        </div>
          <div class="ui-field-contain">
            <label for="text-port">Port:</label>
            <input type="text" name="text-port" id="text-port" value="" />
        </div>
          <input type="button" href="#" value="Add Device" />
      </form>
      </div>
      <!-- /content -->

    </div>

  </body>
</html>